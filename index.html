<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Dashboard â€“ Phoenix Education Institute</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
  <!-- Auth + sidebar helpers â€” plain script (before modules) -->
  <script>
    // Auth guard â€” admin only
    (function () {
      try {
        const s = JSON.parse(localStorage.getItem('phoenixSession') || 'null');
        if (!s && !localStorage.getItem('phoenixAuth')) { location.replace('login.html'); return; }
        if (s && s.role !== 'admin') { location.replace('pages/lms-portal.html'); return; }
      } catch { location.replace('login.html'); }
    })();
    function toggleSidebar() {
      document.getElementById('sidebar')?.classList.toggle('-translate-x-full');
      document.getElementById('overlay')?.classList.toggle('hidden');
    }
    function closeSidebar() {
      document.getElementById('sidebar')?.classList.add('-translate-x-full');
      document.getElementById('overlay')?.classList.add('hidden');
    }
    function logout() { localStorage.clear(); location.replace('login.html'); }
  </script>
</head>

<body class="bg-gray-950 text-gray-100 antialiased font-sans">

  <div class="lg:flex lg:h-screen">

    <!-- Overlay (mobile) -->
    <div id="overlay" class="fixed inset-0 bg-black/60 z-40 hidden lg:hidden" onclick="closeSidebar()"></div>

    <!-- â”€â”€ Sidebar â”€â”€ -->
    <aside id="sidebar"
      class="fixed lg:sticky top-0 left-0 h-screen w-64 bg-gray-900 border-r border-gray-800 flex flex-col z-50 -translate-x-full lg:translate-x-0 transition-transform duration-300 shrink-0">
      <div class="p-5 border-b border-gray-800 flex items-center gap-3">
        <img src="asset/phoenixlogo.jpg" alt="Phoenix Education Institute"
          class="w-9 h-9 rounded-xl object-cover shadow-lg shrink-0">
        <div>
          <div class="font-bold text-white text-sm">Phoenix Education Institute</div>
          <div class="text-[11px] text-gray-500">Student Management System</div>
        </div>
      </div>
      <nav class="flex-1 p-3 space-y-0.5 overflow-y-auto">
        <p class="text-[10px] font-semibold text-gray-600 uppercase tracking-wider px-3 pt-3 pb-2">Main</p>
        <a href="index.html"
          class="flex items-center gap-3 px-3 py-2.5 rounded-xl bg-indigo-500/10 text-indigo-400 text-sm font-semibold"><span
            class="text-lg w-7 text-center">ğŸ“Š</span>Dashboard</a>
        <a href="pages/students.html"
          class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
            class="text-lg w-7 text-center">ğŸ‘¨â€ğŸ“</span>Students</a>
        <a href="pages/attendance.html"
          class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
            class="text-lg w-7 text-center">ğŸ“‹</span>Attendance</a>
        <a href="pages/payments.html"
          class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
            class="text-lg w-7 text-center">ğŸ’³</span>Payments</a>
        <a href="pages/tute-distribution.html"
          class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
            class="text-lg w-7 text-center">ğŸ“¦</span>Tute Distribution</a>
        <p class="text-[10px] font-semibold text-gray-600 uppercase tracking-wider px-3 pt-4 pb-2">Scanner</p>
        <a href="pages/scanner.html"
          class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
            class="text-lg w-7 text-center">ğŸ“·</span>QR Scanner</a>
        <a href="pages/qr-codes.html"
          class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
            class="text-lg w-7 text-center">ğŸ”²</span>QR Codes</a>
        <p class="text-[10px] font-semibold text-gray-600 uppercase tracking-wider px-3 pt-4 pb-2">LMS</p>
        <a href="pages/lms-portal.html"
          class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
            class="text-lg w-7 text-center">ğŸ“</span>LMS Portal</a>
        <a href="pages/lms-lessons.html"
          class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
            class="text-lg w-7 text-center">ğŸ“š</span>Lessons</a>
        <a href="pages/lms-results.html"
          class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
            class="text-lg w-7 text-center">ğŸ“</span>Results</a>
        <a href="pages/lms-documents.html"
          class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
            class="text-lg w-7 text-center">ğŸ“</span>Documents</a>
        <a href="pages/lms-notifications.html"
          class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
            class="text-lg w-7 text-center">ğŸ””</span>Notifications</a>
        <p class="text-[10px] font-semibold text-gray-600 uppercase tracking-wider px-3 pt-4 pb-2">Admin</p>
        <a href="pages/users.html"
          class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
            class="text-lg w-7 text-center">ğŸ‘¤</span>User Accounts</a>
      </nav>
      <div class="p-4 border-t border-gray-800">
        <div class="flex items-center gap-2 px-2">
          <div
            class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center text-xs font-bold text-white shrink-0">
            A</div>
          <div class="flex-1 min-w-0">
            <div class="text-xs font-semibold text-white">Admin</div>
            <div class="text-[10px] text-gray-500">Institute Manager</div>
          </div>
          <button onclick="logout()" title="Sign out"
            class="w-7 h-7 flex items-center justify-center rounded-lg bg-gray-800 hover:bg-red-500/20 hover:text-red-400 text-gray-500 transition-colors text-sm shrink-0">â†©</button>
        </div>
      </div>
    </aside>

    <!-- â”€â”€ Main â”€â”€ -->
    <div class="flex-1 flex flex-col min-h-screen lg:overflow-y-auto">

      <!-- Mobile header -->
      <header
        class="lg:hidden sticky top-0 z-30 bg-gray-900/95 backdrop-blur border-b border-gray-800 px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button onclick="toggleSidebar()"
            class="w-9 h-9 flex items-center justify-center rounded-xl bg-gray-800 hover:bg-gray-700 transition-colors text-gray-300">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 5h12M3 9h12M3 13h12" />
            </svg>
          </button>
          <span class="font-bold text-white">Dashboard</span>
        </div>
        <a href="pages/students.html"
          class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg font-medium transition-colors">+
          Student</a>
      </header>

      <!-- Desktop header -->
      <header
        class="hidden lg:flex sticky top-0 z-30 bg-gray-900/80 backdrop-blur border-b border-gray-800 px-8 py-4 items-center justify-between">
        <div>
          <h1 class="text-xl font-bold text-white">Dashboard</h1>
          <p class="text-sm text-gray-500" id="todayDate">Loading...</p>
        </div>
        <a href="pages/students.html"
          class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl text-sm font-semibold transition-colors shadow-lg shadow-indigo-500/25">
          <span>+</span> Add Student
        </a>
      </header>

      <!-- Content -->
      <div class="flex-1 p-4 lg:p-8 pb-24 lg:pb-8 space-y-6">

        <!-- Stats -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 lg:gap-4">
          <div class="bg-gray-900 border border-gray-800 rounded-2xl p-4 hover:border-indigo-500/40 transition-colors">
            <div class="w-10 h-10 bg-indigo-500/10 rounded-xl flex items-center justify-center text-xl mb-3">ğŸ‘¨â€ğŸ“</div>
            <div class="text-2xl lg:text-3xl font-bold text-white" id="s1">â€”</div>
            <div class="text-xs text-gray-500 mt-0.5">Total Students</div>
          </div>
          <div class="bg-gray-900 border border-gray-800 rounded-2xl p-4 hover:border-emerald-500/40 transition-colors">
            <div class="w-10 h-10 bg-emerald-500/10 rounded-xl flex items-center justify-center text-xl mb-3">âœ…</div>
            <div class="text-2xl lg:text-3xl font-bold text-white" id="s2">â€”</div>
            <div class="text-xs text-gray-500 mt-0.5">Present Today</div>
          </div>
          <div class="bg-gray-900 border border-gray-800 rounded-2xl p-4 hover:border-amber-500/40 transition-colors">
            <div class="w-10 h-10 bg-amber-500/10 rounded-xl flex items-center justify-center text-xl mb-3">ğŸ’³</div>
            <div class="text-2xl lg:text-3xl font-bold text-white" id="s3">â€”</div>
            <div class="text-xs text-gray-500 mt-0.5">Paid This Month</div>
          </div>
          <div class="bg-gray-900 border border-gray-800 rounded-2xl p-4 hover:border-red-500/40 transition-colors">
            <div class="w-10 h-10 bg-red-500/10 rounded-xl flex items-center justify-center text-xl mb-3">âš ï¸</div>
            <div class="text-2xl lg:text-3xl font-bold text-white" id="s4">â€”</div>
            <div class="text-xs text-gray-500 mt-0.5">Unpaid This Month</div>
          </div>
        </div>

        <!-- Grid: Attendance + Activity -->
        <div class="grid lg:grid-cols-2 gap-4 lg:gap-6">

          <!-- Today Attendance -->
          <div class="bg-gray-900 border border-gray-800 rounded-2xl overflow-hidden">
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-800">
              <div>
                <h2 class="font-semibold text-white text-sm">ğŸ“‹ Today's Attendance</h2>
                <p class="text-xs text-gray-500 mt-0.5" id="todayAttSub">â€”</p>
              </div>
              <a href="pages/attendance.html"
                class="text-xs text-indigo-400 hover:text-indigo-300 font-medium transition-colors">View all â†’</a>
            </div>
            <div class="p-4 space-y-1" id="attList">
              <div class="flex items-center justify-center py-8 gap-2 text-gray-600 text-sm">
                <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.37 0 0 5.37 0 12h4z" />
                </svg>
                Loadingâ€¦
              </div>
            </div>
          </div>

          <!-- Subject Breakdown -->
          <div class="bg-gray-900 border border-gray-800 rounded-2xl overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-800">
              <h2 class="font-semibold text-white text-sm">ğŸ“š Enrollment Breakdown</h2>
              <p class="text-xs text-gray-500 mt-0.5">Students per subject & grade</p>
            </div>
            <div class="p-4 grid grid-cols-2 gap-3" id="breakdown">
              <div class="col-span-2 flex items-center justify-center py-8 gap-2 text-gray-600 text-sm">
                <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.37 0 0 5.37 0 12h4z" />
                </svg>
                Loadingâ€¦
              </div>
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>

  <!-- Mobile Bottom Nav -->
  <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-gray-900/95 border-t border-gray-800 backdrop-blur-sm z-40">
    <div class="flex items-center justify-around px-1 py-1">
      <a href="index.html" class="flex flex-col items-center gap-0.5 px-3 py-2 rounded-xl text-indigo-400"><span
          class="text-xl">ğŸ“Š</span><span class="text-[10px] font-semibold">Home</span></a>
      <a href="pages/students.html" class="flex flex-col items-center gap-0.5 px-3 py-2 rounded-xl text-gray-500"><span
          class="text-xl">ğŸ‘¨â€ğŸ“</span><span class="text-[10px]">Students</span></a>
      <a href="pages/scanner.html" class="flex flex-col items-center gap-0.5 px-3 py-2 rounded-xl text-gray-500"><span
          class="text-xl">ğŸ“·</span><span class="text-[10px]">Scan</span></a>
      <a href="pages/attendance.html"
        class="flex flex-col items-center gap-0.5 px-3 py-2 rounded-xl text-gray-500"><span
          class="text-xl">ğŸ“‹</span><span class="text-[10px]">Attend.</span></a>
      <a href="pages/payments.html" class="flex flex-col items-center gap-0.5 px-3 py-2 rounded-xl text-gray-500"><span
          class="text-xl">ğŸ’³</span><span class="text-[10px]">Payments</span></a>
    </div>
  </nav>

  <script type="module">
    import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { db } from "./js/firebase-config.js";
    import { todayStr, formatTime, initials, currentMonthStr, getSubjects } from "./js/app.js";

    document.getElementById('todayDate').textContent =
      new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    async function load() {
      try {
        const today = todayStr(), month = currentMonthStr();
        const [studSnap, attSnap, paySnap] = await Promise.all([
          getDocs(collection(db, 'students')),
          getDocs(query(collection(db, 'attendance'), where('date', '==', today))),
          getDocs(query(collection(db, 'payments'), where('month', '==', month))),
        ]);

        const students = []; studSnap.forEach(d => students.push({ id: d.id, ...d.data() }));
        const att = []; attSnap.forEach(d => att.push({ id: d.id, ...d.data() }));
        const pays = []; paySnap.forEach(d => pays.push({ id: d.id, ...d.data() }));

        // Count payment slots (per student per subject)
        let totalSlots = 0, paidSlots = 0;
        students.forEach(s => {
          const subs = getSubjects(s);
          totalSlots += subs.length;
          subs.forEach(sub => { if (pays.find(p => p.studentId === s.id && p.subject === sub && p.paid)) paidSlots++; });
        });

        document.getElementById('s1').textContent = students.length;
        document.getElementById('s2').textContent = att.length;
        document.getElementById('s3').textContent = paidSlots;
        document.getElementById('s4').textContent = Math.max(0, totalSlots - paidSlots);

        // Today attendance list
        const sMap = {}; students.forEach(s => sMap[s.id] = s);
        const attEl = document.getElementById('attList');
        document.getElementById('todayAttSub').textContent = `${att.length} student${att.length !== 1 ? 's' : ''} scanned in`;
        if (att.length === 0) {
          attEl.innerHTML = `<div class="text-center py-8 text-gray-600 text-sm">No scans yet today.<br><a href="pages/scanner.html" class="text-indigo-400 hover:underline mt-1 inline-block">Open scanner â†’</a></div>`;
        } else {
          att.sort((a, b) => (b.scannedAt?.seconds || 0) - (a.scannedAt?.seconds || 0));
          attEl.innerHTML = att.slice(0, 8).map(r => {
            const s = sMap[r.studentId] || {}; const ini = initials(s.firstName, s.lastName);
            return `<div class="flex items-center gap-3 py-2 px-2 rounded-xl hover:bg-gray-800 transition-colors">
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center text-xs font-bold text-white shrink-0">${ini}</div>
          <div class="flex-1 min-w-0"><div class="text-sm font-medium text-white truncate">${s.firstName || '?'} ${s.lastName || ''}</div>
          <div class="text-xs text-gray-500">Grade ${s.grade || '?'}</div></div>
          <div class="text-xs text-gray-500 shrink-0">${formatTime(r.scannedAt?.toDate?.() || r.scannedAt)}</div>
        </div>`;
          }).join('');
        }

        // Breakdown by subject+grade
        const gradeCounts = (list) => ([6, 7, 8, 9, 10, 11].map(g => {
          const n = list.filter(s => Number(s.grade) === g).length;
          return n ? `<div class="flex justify-between text-xs py-1.5 border-b border-gray-800 last:border-0"><span class="text-gray-400">Grade ${g}</span><span class="font-semibold text-white">${n}</span></div>` : ''
        }).join(''));

        const sci = students.filter(s => getSubjects(s).includes('Science'));
        const math = students.filter(s => getSubjects(s).includes('Maths'));

        const tamil = students.filter(s => getSubjects(s).includes('Tamil'));
        const english = students.filter(s => getSubjects(s).includes('English'));
        document.getElementById('breakdown').innerHTML = `
      <div class="bg-emerald-500/5 border border-emerald-500/20 rounded-xl p-3">
        <div class="text-xs font-semibold text-emerald-400 mb-2">ğŸ”¬ Science <span class="ml-1 bg-emerald-500/20 px-1.5 py-0.5 rounded-full">${sci.length}</span></div>
        ${gradeCounts(sci) || '<p class="text-xs text-gray-600">No students</p>'}
      </div>
      <div class="bg-amber-500/5 border border-amber-500/20 rounded-xl p-3">
        <div class="text-xs font-semibold text-amber-400 mb-2">ğŸ“ Maths <span class="ml-1 bg-amber-500/20 px-1.5 py-0.5 rounded-full">${math.length}</span></div>
        ${gradeCounts(math) || '<p class="text-xs text-gray-600">No students</p>'}
      </div>
      <div class="bg-sky-500/5 border border-sky-500/20 rounded-xl p-3">
        <div class="text-xs font-semibold text-sky-400 mb-2">ğŸ“– Tamil <span class="ml-1 bg-sky-500/20 px-1.5 py-0.5 rounded-full">${tamil.length}</span></div>
        ${gradeCounts(tamil) || '<p class="text-xs text-gray-600">No students</p>'}
      </div>
      <div class="bg-violet-500/5 border border-violet-500/20 rounded-xl p-3">
        <div class="text-xs font-semibold text-violet-400 mb-2">ğŸ“ English <span class="ml-1 bg-violet-500/20 px-1.5 py-0.5 rounded-full">${english.length}</span></div>
        ${gradeCounts(english) || '<p class="text-xs text-gray-600">No students</p>'}
      </div>`;

      } catch (err) {
        console.error('Firebase load error:', err);
        const msg = `<div class="text-center py-6 text-red-400 text-xs">âš ï¸ ${err.message}</div>`;
        const errSmall = `<span class="text-red-400 text-xs">Err</span>`;
        document.getElementById('attList').innerHTML = msg;
        document.getElementById('breakdown').innerHTML = msg;
        document.getElementById('s1').innerHTML = errSmall;
        document.getElementById('s2').innerHTML = errSmall;
        document.getElementById('s3').innerHTML = errSmall;
        document.getElementById('s4').innerHTML = errSmall;
      }
    }
    load();
  </script>
</body>

</html>