<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard â€“ Phonex Institute</title>
  <meta name="description" content="Phonex Institute Management System â€“ Dashboard overview of students, attendance, and payments.">
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
</head>
<body>

<!-- Mobile sidebar overlay -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div class="app-layout">

  <!-- â”€â”€ Sidebar â”€â”€ -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">ğŸ“</div>
      <div class="logo-text">
        <h2>Phonex</h2>
        <p>Institute System</p>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section-title">Main</div>
      <a href="index.html" class="nav-link">
        <div class="nav-icon">ğŸ“Š</div> Dashboard
      </a>
      <a href="pages/students.html" class="nav-link">
        <div class="nav-icon">ğŸ‘¨â€ğŸ“</div> Students
      </a>
      <a href="pages/attendance.html" class="nav-link">
        <div class="nav-icon">ğŸ“‹</div> Attendance
      </a>
      <a href="pages/payments.html" class="nav-link">
        <div class="nav-icon">ğŸ’³</div> Payments
      </a>
      <div class="nav-section-title" style="margin-top:8px">Scanner</div>
      <a href="pages/scanner.html" class="nav-link">
        <div class="nav-icon">ğŸ“·</div> QR Scanner
      </a>
      <a href="pages/qr-codes.html" class="nav-link">
        <div class="nav-icon">ğŸ”²</div> QR Codes
      </a>
    </nav>

    <div class="sidebar-footer">
      <div class="sidebar-user">
        <div class="user-avatar">A</div>
        <div>
          <div style="font-size:13px;font-weight:600">Admin</div>
          <div style="font-size:11px;color:var(--text-muted)">Institute Manager</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ Main Content â”€â”€ -->
  <div class="main-content">

    <!-- Top Bar -->
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:12px">
        <button class="mobile-menu-btn" id="mobileMenuBtn">â˜°</button>
        <div class="topbar-left">
          <h1>Dashboard</h1>
          <p id="todayDate">Loading...</p>
        </div>
      </div>
      <div class="topbar-right">
        <a href="pages/students.html" class="btn btn-primary btn-sm">+ Add Student</a>
      </div>
    </div>

    <!-- Page Content -->
    <div class="page-content">

      <!-- Stats -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-icon purple">ğŸ‘¨â€ğŸ“</div>
          <div class="stat-info">
            <h3 id="statTotal">â€“</h3>
            <p>Total Students</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green">âœ…</div>
          <div class="stat-info">
            <h3 id="statToday">â€“</h3>
            <p>Present Today</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon yellow">ğŸ’³</div>
          <div class="stat-info">
            <h3 id="statPaid">â€“</h3>
            <p>Paid This Month</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon red">âš ï¸</div>
          <div class="stat-info">
            <h3 id="statUnpaid">â€“</h3>
            <p>Unpaid This Month</p>
          </div>
        </div>
      </div>

      <!-- Content grid -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">

        <!-- Today Attendance -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">ğŸ“‹ Today's Attendance</div>
              <div class="card-subtitle" id="todayAttSubtitle">Loading...</div>
            </div>
            <a href="pages/attendance.html" class="btn btn-ghost btn-sm">View All â†’</a>
          </div>
          <div class="card-body" id="todayAttList">
            <div class="page-loading"><div class="loading-spinner"></div></div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">ğŸ”” Recent Activity</div>
              <div class="card-subtitle">Latest system events</div>
            </div>
          </div>
          <div class="card-body" id="recentActivity">
            <div class="page-loading"><div class="loading-spinner"></div></div>
          </div>
        </div>

      </div>

      <!-- Subject breakdown -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px">

        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ”¬ Science Class</div>
          </div>
          <div class="card-body" id="scienceBreakdown">
            <div class="page-loading"><div class="loading-spinner"></div></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“ Maths Class</div>
          </div>
          <div class="card-body" id="mathsBreakdown">
            <div class="page-loading"><div class="loading-spinner"></div></div>
          </div>
        </div>

      </div>

    </div><!-- /page-content -->
  </div><!-- /main-content -->
</div><!-- /app-layout -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { firebaseConfig } from "./js/firebase-config.js";
import { todayStr, formatDate, formatTime, initials, currentMonthStr } from "./js/app.js";

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// Date display
const now = new Date();
document.getElementById('todayDate').textContent =
  now.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

// â”€â”€ Load dashboard data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  try {
    const [studentsSnap, attSnap, paymentsSnap] = await Promise.all([
      getDocs(collection(db, 'students')),
      getDocs(query(collection(db, 'attendance'), where('date', '==', todayStr()))),
      getDocs(query(collection(db, 'payments'), where('month', '==', currentMonthStr())))
    ]);

    const students  = [];
    studentsSnap.forEach(d => students.push({ id: d.id, ...d.data() }));

    const todayAtt = [];
    attSnap.forEach(d => todayAtt.push({ id: d.id, ...d.data() }));

    const payments = [];
    paymentsSnap.forEach(d => payments.push({ id: d.id, ...d.data() }));

    const paidIds   = new Set(payments.filter(p => p.paid).map(p => p.studentId));
    const unpaidCnt = students.length - paidIds.size;

    // Stats
    document.getElementById('statTotal').textContent  = students.length;
    document.getElementById('statToday').textContent  = todayAtt.length;
    document.getElementById('statPaid').textContent   = paidIds.size;
    document.getElementById('statUnpaid').textContent = Math.max(0, unpaidCnt);

    // Today's attendance list
    const attList = document.getElementById('todayAttList');
    document.getElementById('todayAttSubtitle').textContent =
      `${todayAtt.length} student${todayAtt.length !== 1 ? 's' : ''} scanned in`;

    if (todayAtt.length === 0) {
      attList.innerHTML = `<div class="empty-state">
        <div class="empty-icon">ğŸ“‹</div>
        <h3>No Attendance Yet</h3>
        <p>No students have scanned in today.</p>
      </div>`;
    } else {
      const sorted = todayAtt.sort((a,b) => b.scannedAt?.seconds - a.scannedAt?.seconds);
      const studentMap = {};
      students.forEach(s => studentMap[s.id] = s);

      attList.innerHTML = sorted.slice(0, 8).map(att => {
        const s = studentMap[att.studentId] || {};
        const ini = initials(s.firstName, s.lastName);
        return `<div class="attendance-item">
          <div class="student-avatar">${ini}</div>
          <div style="flex:1">
            <div class="student-name">${s.firstName || '?'} ${s.lastName || ''}</div>
            <div class="student-id">${s.grade ? 'Grade '+s.grade : ''} â€¢ ${s.subject || ''}</div>
          </div>
          <div class="attendance-time">${formatTime(att.scannedAt?.toDate?.() || att.scannedAt)}</div>
        </div>`;
      }).join('');
    }

    // Subject breakdown
    const grades = [6,7,8,9,10,11];
    const scienceStudents = students.filter(s => s.subject === 'Science');
    const mathsStudents   = students.filter(s => s.subject === 'Maths');
    const bothStudents    = students.filter(s => s.subject === 'Both');

    function gradeRows(list) {
      return grades.map(g => {
        const cnt = list.filter(s => Number(s.grade) === g).length;
        return cnt > 0 ? `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">
          <span style="font-size:13px;color:var(--text-secondary)">Grade ${g}</span>
          <span class="badge badge-info">${cnt} student${cnt !== 1 ? 's' : ''}</span>
        </div>` : '';
      }).join('');
    }

    document.getElementById('scienceBreakdown').innerHTML =
      `<div style="margin-bottom:8px;font-size:12px;color:var(--text-muted)">
        Total: <strong style="color:var(--success)">${scienceStudents.length + bothStudents.length} students</strong>
       </div>` + (gradeRows([...scienceStudents,...bothStudents]) || '<p style="color:var(--text-muted);font-size:13px">No students yet</p>');

    document.getElementById('mathsBreakdown').innerHTML =
      `<div style="margin-bottom:8px;font-size:12px;color:var(--text-muted)">
        Total: <strong style="color:var(--warning)">${mathsStudents.length + bothStudents.length} students</strong>
       </div>` + (gradeRows([...mathsStudents,...bothStudents]) || '<p style="color:var(--text-muted);font-size:13px">No students yet</p>');

    // Recent activity (last 6 attendance records across all days)
    const recentAttSnap = await getDocs(query(
      collection(db, 'attendance'),
      orderBy('scannedAt', 'desc'),
      limit(6)
    ));

    const recentAtt = [];
    recentAttSnap.forEach(d => recentAtt.push({ id: d.id, ...d.data() }));

    const actEl = document.getElementById('recentActivity');
    if (recentAtt.length === 0) {
      actEl.innerHTML = `<div class="empty-state">
        <div class="empty-icon">ğŸ””</div>
        <h3>No Activity Yet</h3>
        <p>Scan student QR codes to see activity here.</p>
      </div>`;
    } else {
      actEl.innerHTML = recentAtt.map(att => {
        const s = studentMap?.[att.studentId] || {};
        const name = s.firstName ? `${s.firstName} ${s.lastName}` : 'Unknown Student';
        const time = formatTime(att.scannedAt?.toDate?.() || att.scannedAt);
        const dateStr = formatDate(att.date);
        return `<div class="activity-item">
          <div class="activity-dot green"></div>
          <div class="activity-content">
            <p><strong>${name}</strong> scanned in</p>
            <span>${dateStr} at ${time}</span>
          </div>
        </div>`;
      }).join('');
    }

  } catch (err) {
    console.error(err);
    document.getElementById('todayAttList').innerHTML =
      `<div class="empty-state"><div class="empty-icon">âš ï¸</div>
       <h3>Firebase not configured</h3>
       <p>Please set up your Firebase credentials in <code>js/firebase-config.js</code></p></div>`;
  }
}

loadDashboard();
</script>

</body>
</html>
