<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>User Accounts ‚Äì Phoenix Education Institute</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        (function () {
            try {
                const s = JSON.parse(localStorage.getItem('phoenixSession') || 'null');
                const legacy = localStorage.getItem('phoenixAuth');
                if (!s && !legacy) { location.replace('../login.html'); }
                else if (s && s.role !== 'admin') { location.replace('lms-portal.html'); }
            } catch { location.replace('../login.html'); }
        })();
        function toggleSidebar() {
            document.getElementById('sidebar')?.classList.toggle('-translate-x-full');
            document.getElementById('overlay')?.classList.toggle('hidden');
        }
        function closeSidebar() {
            document.getElementById('sidebar')?.classList.add('-translate-x-full');
            document.getElementById('overlay')?.classList.add('hidden');
        }
        function logout() {
            localStorage.clear();
            location.replace('../login.html');
        }
    </script>
</head>

<body class="bg-gray-950 text-gray-100 antialiased font-sans">
    <div class="lg:flex lg:h-screen">
        <div id="overlay" class="fixed inset-0 bg-black/60 z-40 hidden lg:hidden" onclick="closeSidebar()"></div>

        <!-- Sidebar -->
        <aside id="sidebar"
            class="fixed lg:sticky top-0 left-0 h-screen w-64 bg-gray-900 border-r border-gray-800 flex flex-col z-50 -translate-x-full lg:translate-x-0 transition-transform duration-300 shrink-0">
            <div class="p-5 border-b border-gray-800 flex items-center gap-3">
                <img src="../asset/phoenixlogo.jpg" alt="Phoenix"
                    class="w-9 h-9 rounded-xl object-cover shadow-lg shrink-0" onerror="this.style.display='none'">
                <div>
                    <div class="font-bold text-white text-sm">Phoenix Institute</div>
                    <div class="text-[11px] text-gray-500">Admin Panel</div>
                </div>
            </div>
            <nav class="flex-1 p-3 space-y-0.5 overflow-y-auto">
                <p class="text-[10px] font-semibold text-gray-600 uppercase tracking-wider px-3 pt-3 pb-2">Main</p>
                <a href="../index.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üìä</span>Dashboard</a>
                <a href="students.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üë®‚Äçüéì</span>Students</a>
                <a href="attendance.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üìã</span>Attendance</a>
                <a href="payments.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üí≥</span>Payments</a>
                <p class="text-[10px] font-semibold text-gray-600 uppercase tracking-wider px-3 pt-4 pb-2">LMS</p>
                <a href="lms-portal.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üéì</span>LMS Portal</a>
                <a href="lms-lessons.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üìö</span>Lessons</a>
                <a href="lms-results.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üìù</span>Results</a>
                <a href="lms-documents.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üìÅ</span>Documents</a>
                <a href="lms-notifications.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üîî</span>Notifications</a>
                <p class="text-[10px] font-semibold text-gray-600 uppercase tracking-wider px-3 pt-4 pb-2">Admin</p>
                <a href="users.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl bg-indigo-500/10 text-indigo-400 text-sm font-semibold"><span
                        class="text-lg w-7 text-center">üë§</span>User Accounts</a>
                <a href="scanner.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üì∑</span>QR Scanner</a>
                <a href="qr-codes.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üî≤</span>QR Codes</a>
            </nav>
            <div class="p-4 border-t border-gray-800">
                <div class="flex items-center gap-2 px-2">
                    <div
                        class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center text-xs font-bold shrink-0">
                        A</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-semibold text-white" id="sidebarUser">Admin</div>
                        <div class="text-[10px] text-gray-500">Institute Manager</div>
                    </div>
                    <button onclick="logout()" title="Sign out"
                        class="w-7 h-7 flex items-center justify-center rounded-lg bg-gray-800 hover:bg-red-500/20 hover:text-red-400 text-gray-500 transition-colors text-sm shrink-0">‚Ü©</button>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <div class="flex-1 flex flex-col min-h-screen lg:overflow-y-auto">
            <header
                class="lg:hidden sticky top-0 z-30 bg-gray-900/95 backdrop-blur border-b border-gray-800 px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()"
                        class="w-9 h-9 flex items-center justify-center rounded-xl bg-gray-800 hover:bg-gray-700 transition-colors text-gray-300">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 5h12M3 9h12M3 13h12" />
                        </svg>
                    </button>
                    <span class="font-bold text-white">User Accounts</span>
                </div>
                <button onclick="openAdd()"
                    class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg font-medium transition-colors">+
                    Add</button>
            </header>

            <header
                class="hidden lg:flex sticky top-0 z-30 bg-gray-900/80 backdrop-blur border-b border-gray-800 px-8 py-4 items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-white">User Accounts</h1>
                    <p class="text-sm text-gray-500" id="countBadge">Loading‚Ä¶</p>
                </div>
                <button onclick="openAdd()"
                    class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl text-sm font-semibold transition-colors shadow-lg shadow-indigo-500/25">+
                    Add User</button>
            </header>

            <div class="flex-1 p-4 lg:p-8 pb-24 lg:pb-8">
                <!-- Info banner -->
                <div class="bg-amber-500/10 border border-amber-500/20 rounded-2xl p-4 mb-6 flex items-start gap-3">
                    <span class="text-amber-400 text-xl shrink-0">üîí</span>
                    <div>
                        <div class="text-sm font-semibold text-amber-300">Admin-Only Page</div>
                        <div class="text-xs text-amber-400/70 mt-0.5">Manage all user accounts here. Students with user
                            accounts can log in to the LMS portal to view their lessons, results, and documents.</div>
                    </div>
                </div>

                <!-- Search -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <div class="relative flex-1 min-w-[200px]">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">üîç</span>
                        <input id="q" type="text" placeholder="Search username or name‚Ä¶" oninput="filterUsers()"
                            class="w-full bg-gray-900 border border-gray-700 rounded-xl pl-9 pr-3 py-2 text-sm text-gray-100 placeholder-gray-600 focus:outline-none focus:border-indigo-500 transition-colors">
                    </div>
                    <select id="fRole" onchange="filterUsers()"
                        class="bg-gray-900 border border-gray-700 rounded-xl px-3 py-2 text-sm text-gray-300 focus:outline-none focus:border-indigo-500 transition-colors">
                        <option value="">All Roles</option>
                        <option value="admin">Admin</option>
                        <option value="student">Student</option>
                    </select>
                </div>

                <!-- Table -->
                <div class="bg-gray-900 border border-gray-800 rounded-2xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-800 bg-gray-800/50">
                                    <th
                                        class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        User</th>
                                    <th
                                        class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider hidden sm:table-cell">
                                        Username</th>
                                    <th
                                        class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        Role</th>
                                    <th
                                        class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider hidden md:table-cell">
                                        Linked Student</th>
                                    <th
                                        class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider hidden lg:table-cell">
                                        Status</th>
                                    <th
                                        class="text-right px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tbody">
                                <tr>
                                    <td colspan="6" class="text-center py-12 text-gray-600">
                                        <svg class="animate-spin w-5 h-5 mx-auto mb-2" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                                stroke-width="4" />
                                            <path class="opacity-75" fill="currentColor"
                                                d="M4 12a8 8 0 018-8V0C5.37 0 0 5.37 0 12h4z" />
                                        </svg>
                                        Loading users‚Ä¶
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="modal"
        class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div
            class="modal-enter bg-gray-900 border border-gray-700 rounded-t-3xl sm:rounded-2xl w-full sm:max-w-lg max-h-[95vh] overflow-y-auto shadow-2xl">
            <div
                class="flex items-center justify-between px-6 py-4 border-b border-gray-800 sticky top-0 bg-gray-900 rounded-t-3xl sm:rounded-t-2xl">
                <h2 class="font-bold text-white text-base" id="modalTitle">Add User</h2>
                <button onclick="closeModal()"
                    class="w-8 h-8 flex items-center justify-center rounded-xl bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white transition-colors text-lg">‚úï</button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="editId">
                <div>
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5 block">Display
                        Name *</label>
                    <input id="displayName"
                        class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-indigo-500 transition-colors"
                        placeholder="e.g. Kamal Perera">
                </div>
                <div>
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5 block">Username
                        *</label>
                    <input id="username"
                        class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-indigo-500 transition-colors"
                        placeholder="e.g. kamal2024">
                    <p class="text-[11px] text-gray-600 mt-1">Lowercase letters, numbers, underscores only</p>
                </div>
                <div>
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5 block">Password
                        *</label>
                    <div class="relative">
                        <input id="password" type="password"
                            class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-indigo-500 transition-colors pr-10"
                            placeholder="Min 6 characters">
                        <button type="button" onclick="toggleModalPwd()"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-300">üëÅÔ∏è</button>
                    </div>
                    <p class="text-[11px] text-gray-600 mt-1" id="pwdHint">Leave blank to keep existing password (edit
                        mode)</p>
                </div>
                <div>
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5 block">Role
                        *</label>
                    <select id="role" onchange="onRoleChange()"
                        class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500 transition-colors">
                        <option value="student">Student</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div id="studentLinkRow">
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5 block">Link to
                        Student Record</label>
                    <select id="studentId"
                        class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500 transition-colors">
                        <option value="">‚Äî No link ‚Äî</option>
                    </select>
                    <p class="text-[11px] text-gray-600 mt-1">Linking allows the student to see their personalised
                        results</p>
                </div>
                <div class="flex items-center justify-between bg-gray-800 border border-gray-700 rounded-xl px-4 py-3">
                    <div>
                        <div class="text-sm font-semibold text-white">Active Account</div>
                        <div class="text-[11px] text-gray-500 mt-0.5">Inactive users cannot log in</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer shrink-0 ml-3">
                        <input type="checkbox" id="chkActive" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer
                        peer-checked:after:translate-x-full peer-checked:after:border-white
                        after:content-[''] after:absolute after:top-0.5 after:left-[2px]
                        after:bg-white after:border-gray-300 after:border after:rounded-full
                        after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                    </label>
                </div>
            </div>
            <div
                class="flex items-center gap-3 px-6 py-4 border-t border-gray-800 sticky bottom-0 bg-gray-900 rounded-b-2xl">
                <button onclick="closeModal()"
                    class="flex-1 py-2.5 rounded-xl bg-gray-800 hover:bg-gray-700 text-gray-300 text-sm font-medium transition-colors">Cancel</button>
                <button onclick="saveUser()" id="saveBtn"
                    class="flex-1 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold transition-colors shadow-lg shadow-indigo-500/25">
                    <span id="saveTxt">Add User</span>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { collection, addDoc, updateDoc, deleteDoc, getDocs, doc, serverTimestamp, query, orderBy }
            from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { db } from "../js/firebase-config.js";
        import { showToast, confirmAction } from "../js/app.js";

        // Set sidebar username
        try {
            const s = JSON.parse(localStorage.getItem('phoenixSession') || 'null');
            if (s) document.getElementById('sidebarUser').textContent = s.displayName || s.username;
        } catch { }

        let allUsers = [];
        let allStudents = [];

        async function loadStudents() {
            const snap = await getDocs(collection(db, 'students'));
            allStudents = [];
            snap.forEach(d => allStudents.push({ id: d.id, ...d.data() }));
            allStudents.sort((a, b) => (`${a.firstName} ${a.lastName}`).localeCompare(`${b.firstName} ${b.lastName}`));
            const sel = document.getElementById('studentId');
            const current = sel.value;
            while (sel.options.length > 1) sel.remove(1);
            allStudents.forEach(s => {
                const opt = new Option(`${s.firstName} ${s.lastName} (Grade ${s.grade})`, s.id);
                sel.appendChild(opt);
            });
            if (current) sel.value = current;
        }

        async function load() {
            const snap = await getDocs(collection(db, 'users'));
            allUsers = [];
            snap.forEach(d => allUsers.push({ id: d.id, ...d.data() }));
            allUsers.sort((a, b) => (a.displayName || a.username).localeCompare(b.displayName || b.username));
            render(allUsers);
            document.getElementById('countBadge').textContent = `${allUsers.length} user${allUsers.length !== 1 ? 's' : ''}`;
        }

        function render(list) {
            const tb = document.getElementById('tbody');
            if (!list.length) {
                tb.innerHTML = `<tr><td colspan="6" class="text-center py-16 text-gray-600">
                <div class="text-4xl mb-3 opacity-30">üë§</div>
                <div class="font-medium text-gray-500">No users found</div>
                <div class="text-sm mt-1">Add your first user account</div>
            </td></tr>`;
                return;
            }
            tb.innerHTML = list.map(u => {
                const initials = ((u.displayName || u.username || '?')[0]).toUpperCase();
                const roleColor = u.role === 'admin' ? 'bg-violet-500/10 text-violet-400 border-violet-500/20' : 'bg-sky-500/10 text-sky-400 border-sky-500/20';
                const roleLabel = u.role === 'admin' ? 'üõ°Ô∏è Admin' : 'üéì Student';
                const activeLabel = u.active !== false
                    ? '<span class="inline-flex items-center px-2 py-0.5 rounded-lg bg-emerald-500/10 text-emerald-400 text-[11px] font-medium border border-emerald-500/20">‚úÖ Active</span>'
                    : '<span class="inline-flex items-center px-2 py-0.5 rounded-lg bg-red-500/10 text-red-400 text-[11px] font-medium border border-red-500/20">‚õî Inactive</span>';
                const linked = u.studentId ? (allStudents.find(s => s.id === u.studentId) || null) : null;
                const linkedLabel = linked ? `${linked.firstName} ${linked.lastName}` : '‚Äî';
                return `<tr class="border-b border-gray-800 hover:bg-gray-800/50 transition-colors">
                <td class="px-4 py-3">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center text-xs font-bold text-white shrink-0">${initials}</div>
                        <div><div class="font-medium text-white text-sm">${u.displayName || u.username}</div><div class="text-xs text-gray-500">${u.id.slice(0, 8).toUpperCase()}</div></div>
                    </div>
                </td>
                <td class="px-4 py-3 text-gray-400 text-sm hidden sm:table-cell font-mono">${u.username}</td>
                <td class="px-4 py-3"><span class="inline-flex items-center px-2 py-0.5 rounded-lg ${roleColor} text-[11px] font-medium border">${roleLabel}</span></td>
                <td class="px-4 py-3 text-gray-400 text-sm hidden md:table-cell">${linkedLabel}</td>
                <td class="px-4 py-3 hidden lg:table-cell">${activeLabel}</td>
                <td class="px-4 py-3">
                    <div class="flex items-center justify-end gap-2">
                        <button onclick="editUser('${u.id}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-gray-800 hover:bg-indigo-500/20 hover:text-indigo-400 text-gray-400 transition-colors text-sm" title="Edit">‚úèÔ∏è</button>
                        <button onclick="resetPwd('${u.id}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-gray-800 hover:bg-amber-500/20 hover:text-amber-400 text-gray-400 transition-colors text-sm" title="Reset Password">üîë</button>
                        <button onclick="deleteUser('${u.id}')" class="w-8 h-8 flex items-center justify-center rounded-lg bg-gray-800 hover:bg-red-500/20 hover:text-red-400 text-gray-400 transition-colors text-sm" title="Delete">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>`;
            }).join('');
        }

        window.filterUsers = function () {
            const q = document.getElementById('q').value.toLowerCase();
            const fr = document.getElementById('fRole').value;
            render(allUsers.filter(u =>
                (!q || `${u.username} ${u.displayName || ''}`.toLowerCase().includes(q)) &&
                (!fr || u.role === fr)
            ));
        };

        window.openAdd = function () {
            document.getElementById('editId').value = '';
            document.getElementById('displayName').value = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('role').value = 'student';
            document.getElementById('studentId').value = '';
            document.getElementById('chkActive').checked = true;
            document.getElementById('modalTitle').textContent = 'Add User';
            document.getElementById('saveTxt').textContent = 'Add User';
            document.getElementById('pwdHint').textContent = 'Minimum 6 characters';
            document.getElementById('studentLinkRow').style.display = '';
            document.getElementById('username').readOnly = false;
            document.getElementById('modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        window.closeModal = function () {
            document.getElementById('modal').classList.add('hidden');
            document.body.style.overflow = '';
        };

        window.onRoleChange = function () {
            const r = document.getElementById('role').value;
            document.getElementById('studentLinkRow').style.display = r === 'student' ? '' : 'none';
        };

        window.toggleModalPwd = function () {
            const p = document.getElementById('password');
            p.type = p.type === 'password' ? 'text' : 'password';
        };

        window.editUser = function (id) {
            const u = allUsers.find(x => x.id === id); if (!u) return;
            document.getElementById('editId').value = id;
            document.getElementById('displayName').value = u.displayName || '';
            document.getElementById('username').value = u.username || '';
            document.getElementById('username').readOnly = true;
            document.getElementById('password').value = '';
            document.getElementById('role').value = u.role || 'student';
            document.getElementById('studentId').value = u.studentId || '';
            document.getElementById('chkActive').checked = u.active !== false;
            document.getElementById('modalTitle').textContent = 'Edit User';
            document.getElementById('saveTxt').textContent = 'Save Changes';
            document.getElementById('pwdHint').textContent = 'Leave blank to keep existing password';
            document.getElementById('studentLinkRow').style.display = (u.role || 'student') === 'student' ? '' : 'none';
            document.getElementById('modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };

        window.saveUser = async function () {
            const editId = document.getElementById('editId').value;
            const displayName = document.getElementById('displayName').value.trim();
            const username = document.getElementById('username').value.trim().toLowerCase();
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            const studentId = document.getElementById('studentId').value || null;
            const active = document.getElementById('chkActive').checked;

            if (!displayName) { showToast('Display name is required', 'error'); return; }
            if (!username) { showToast('Username is required', 'error'); return; }
            if (!/^[a-z0-9_]+$/.test(username)) { showToast('Username: lowercase letters, numbers, underscores only', 'error'); return; }
            if (!editId && !password) { showToast('Password is required for new users', 'error'); return; }
            if (password && password.length < 6) { showToast('Password must be at least 6 characters', 'error'); return; }

            // Check username uniqueness (skip for edit)
            if (!editId) {
                const existing = allUsers.find(u => u.username === username);
                if (existing) { showToast('Username already exists', 'error'); return; }
            }

            const btn = document.getElementById('saveBtn'); btn.disabled = true;
            const data = { displayName, username, role, studentId: role === 'student' ? studentId : null, active, updatedAt: serverTimestamp() };
            if (password) data.password = password;

            try {
                if (editId) {
                    await updateDoc(doc(db, 'users', editId), data);
                    showToast(`${displayName} updated`, 'success');
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'users'), data);
                    showToast(`${displayName} added`, 'success');
                }
                closeModal();
                await load();
            } catch (e) { showToast('Save failed: ' + e.message, 'error'); }
            finally { btn.disabled = false; }
        };

        window.resetPwd = async function (id) {
            const u = allUsers.find(x => x.id === id); if (!u) return;
            const newPwd = prompt(`Enter new password for "${u.displayName || u.username}":\n(Min 6 characters)`);
            if (!newPwd) return;
            if (newPwd.length < 6) { showToast('Password must be at least 6 characters', 'error'); return; }
            try {
                await updateDoc(doc(db, 'users', id), { password: newPwd, updatedAt: serverTimestamp() });
                showToast('Password reset successfully', 'success');
            } catch (e) { showToast('Failed: ' + e.message, 'error'); }
        };

        window.deleteUser = async function (id) {
            const u = allUsers.find(x => x.id === id);
            if (!await confirmAction(`Delete user <strong>${u?.displayName || u?.username}</strong>? This cannot be undone.`)) return;
            try {
                await deleteDoc(doc(db, 'users', id));
                showToast('User deleted', 'info');
                await load();
            } catch (e) { showToast('Delete failed', 'error'); }
        };

        await loadStudents();
        await load();
    </script>
</body>

</html>