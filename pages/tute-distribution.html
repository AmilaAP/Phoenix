<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Tute Distribution ‚Äì Phoenix Institute</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(14px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-anim {
            animation: fadeUp .35s ease both;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(.96) translateY(6px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-enter {
            animation: scaleIn .2s cubic-bezier(.4, 0, .2, 1) forwards;
        }

        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 99px;
        }

        .student-row {
            transition: background .15s;
        }

        .student-row:hover {
            background: rgba(99, 102, 241, .06);
        }

        .check-given {
            accent-color: #6366f1;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
    </style>
    <script>
        (function () {
            try {
                const s = JSON.parse(localStorage.getItem('phoenixSession') || 'null');
                if (!s && !localStorage.getItem('phoenixAuth')) { location.replace('../login.html'); return; }
                if (s && s.role !== 'admin') { location.replace('lms-portal.html'); return; }
            } catch { location.replace('../login.html'); }
        })();
        function toggleSidebar() { document.getElementById('sidebar')?.classList.toggle('-translate-x-full'); document.getElementById('overlay')?.classList.toggle('hidden'); }
        function closeSidebar() { document.getElementById('sidebar')?.classList.add('-translate-x-full'); document.getElementById('overlay')?.classList.add('hidden'); }
        function logout() { localStorage.clear(); location.replace('../login.html'); }
    </script>
</head>

<body class="bg-gray-950 text-gray-100 antialiased">
    <div class="lg:flex lg:h-screen">
        <div id="overlay" class="fixed inset-0 bg-black/60 z-40 hidden lg:hidden" onclick="closeSidebar()"></div>

        <!-- Sidebar -->
        <aside id="sidebar"
            class="fixed lg:sticky top-0 left-0 h-screen w-64 bg-gray-900 border-r border-gray-800 flex flex-col z-50 -translate-x-full lg:translate-x-0 transition-transform duration-300 shrink-0">
            <div class="p-5 border-b border-gray-800 flex items-center gap-3">
                <img src="../asset/phoenixlogo.jpg" alt="Phoenix"
                    class="w-9 h-9 rounded-xl object-cover shadow-lg shrink-0" onerror="this.style.display='none'">
                <div>
                    <div class="font-bold text-white text-sm">Phoenix Institute</div>
                    <div class="text-[11px] text-gray-500">Admin Panel</div>
                </div>
            </div>
            <nav class="flex-1 p-3 space-y-0.5 overflow-y-auto">
                <p class="text-[10px] font-semibold text-gray-600 uppercase tracking-wider px-3 pt-3 pb-2">Main</p>
                <a href="../index.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üìä</span>Dashboard</a>
                <a href="students.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üë®‚Äçüéì</span>Students</a>
                <a href="attendance.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üìã</span>Attendance</a>
                <a href="payments.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üí≥</span>Payments</a>
                <a href="tute-distribution.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl bg-indigo-500/10 text-indigo-400 text-sm font-semibold"><span
                        class="text-lg w-7 text-center">üì¶</span>Tute Distribution</a>
                <p class="text-[10px] font-semibold text-gray-600 uppercase tracking-wider px-3 pt-4 pb-2">Scanner</p>
                <a href="scanner.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üì∑</span>QR Scanner</a>
                <a href="qr-codes.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üî≤</span>QR Codes</a>
                <p class="text-[10px] font-semibold text-gray-600 uppercase tracking-wider px-3 pt-4 pb-2">LMS</p>
                <a href="lms-portal.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üéì</span>LMS Portal</a>
                <a href="lms-lessons.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üìö</span>Lessons</a>
                <a href="lms-results.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üìù</span>Results</a>
                <a href="lms-documents.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üìÅ</span>Documents</a>
                <a href="lms-notifications.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üîî</span>Notifications</a>
                <p class="text-[10px] font-semibold text-gray-600 uppercase tracking-wider px-3 pt-4 pb-2">Admin</p>
                <a href="users.html"
                    class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white text-sm font-medium transition-colors"><span
                        class="text-lg w-7 text-center">üë§</span>User Accounts</a>
            </nav>
            <div class="p-4 border-t border-gray-800">
                <div class="flex items-center gap-2 px-2">
                    <div
                        class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center text-xs font-bold shrink-0">
                        A</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-semibold text-white" id="sidebarUser">Admin</div>
                        <div class="text-[10px] text-gray-500">Institute Manager</div>
                    </div>
                    <button onclick="logout()" title="Sign out"
                        class="w-7 h-7 flex items-center justify-center rounded-lg bg-gray-800 hover:bg-red-500/20 hover:text-red-400 text-gray-500 transition-colors text-sm shrink-0">‚Ü©</button>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <div class="flex-1 flex flex-col min-h-screen lg:overflow-y-auto">
            <!-- Mobile header -->
            <header
                class="lg:hidden sticky top-0 z-30 bg-gray-900/95 backdrop-blur border-b border-gray-800 px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()"
                        class="w-9 h-9 flex items-center justify-center rounded-xl bg-gray-800 hover:bg-gray-700 transition-colors text-gray-300">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 5h12M3 9h12M3 13h12" />
                        </svg>
                    </button>
                    <span class="font-bold text-white">Tute Distribution</span>
                </div>
                <button onclick="openCreateTute()"
                    class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg font-medium transition-colors">+
                    New Tute</button>
            </header>
            <!-- Desktop header -->
            <header
                class="hidden lg:flex sticky top-0 z-30 bg-gray-900/80 backdrop-blur border-b border-gray-800 px-8 py-4 items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold text-white">Tute Distribution</h1>
                    <p class="text-sm text-gray-500">Track which students received each handout</p>
                </div>
                <button onclick="openCreateTute()"
                    class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl text-sm font-semibold transition-colors shadow-lg shadow-indigo-500/25">
                    üì¶ New Tute
                </button>
            </header>

            <div class="flex-1 p-4 lg:p-8 pb-24 lg:pb-8 space-y-5">
                <!-- Tute selector + filters -->
                <div class="bg-gray-900 border border-gray-800 rounded-2xl p-4 lg:p-5">
                    <div class="flex flex-wrap gap-3 items-end">
                        <div class="flex-1 min-w-[200px]">
                            <label
                                class="text-[10px] font-semibold text-gray-500 uppercase tracking-wider mb-1.5 block">Select
                                Tute / Handout</label>
                            <select id="tuteSelect" onchange="loadTuteStudents()"
                                class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-gray-100 focus:outline-none focus:border-indigo-500 transition-colors">
                                <option value="">‚Äî Select a tute ‚Äî</option>
                            </select>
                        </div>
                        <div class="min-w-[140px]">
                            <label
                                class="text-[10px] font-semibold text-gray-500 uppercase tracking-wider mb-1.5 block">Grade</label>
                            <select id="fGrade" onchange="applyFilter()"
                                class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-gray-300 focus:outline-none focus:border-indigo-500 transition-colors">
                                <option value="">All Grades</option>
                                <option>6</option>
                                <option>7</option>
                                <option>8</option>
                                <option>9</option>
                                <option>10</option>
                                <option>11</option>
                            </select>
                        </div>
                        <div class="min-w-[140px]">
                            <label
                                class="text-[10px] font-semibold text-gray-500 uppercase tracking-wider mb-1.5 block">Subject</label>
                            <select id="fSub" onchange="applyFilter()"
                                class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-gray-300 focus:outline-none focus:border-indigo-500 transition-colors">
                                <option value="">All Subjects</option>
                                <option>Science</option>
                                <option>Maths</option>
                                <option>Tamil</option>
                                <option>English</option>
                            </select>
                        </div>
                        <div class="min-w-[140px]">
                            <label
                                class="text-[10px] font-semibold text-gray-500 uppercase tracking-wider mb-1.5 block">Status</label>
                            <select id="fStatus" onchange="applyFilter()"
                                class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-gray-300 focus:outline-none focus:border-indigo-500 transition-colors">
                                <option value="">All</option>
                                <option value="given">Given ‚úÖ</option>
                                <option value="not_given">Not Given ‚ùå</option>
                            </select>
                        </div>
                        <div class="relative flex-1 min-w-[180px]">
                            <label
                                class="text-[10px] font-semibold text-gray-500 uppercase tracking-wider mb-1.5 block">Search
                                Student</label>
                            <span class="absolute left-3 bottom-2.5 text-gray-500 text-sm">üîç</span>
                            <input id="q" type="text" placeholder="Name‚Ä¶" oninput="applyFilter()"
                                class="w-full bg-gray-800 border border-gray-700 rounded-xl pl-9 pr-3 py-2.5 text-sm text-gray-100 placeholder-gray-600 focus:outline-none focus:border-indigo-500 transition-colors">
                        </div>
                    </div>
                </div>

                <!-- Stats bar -->
                <div id="statsBar" class="hidden grid grid-cols-3 gap-3">
                    <div class="bg-gray-900 border border-gray-800 rounded-2xl p-4 text-center">
                        <div class="text-2xl font-bold text-white" id="statTotal">‚Äî</div>
                        <div class="text-xs text-gray-500 mt-0.5">Total Students</div>
                    </div>
                    <div class="bg-gray-900 border border-emerald-500/20 rounded-2xl p-4 text-center">
                        <div class="text-2xl font-bold text-emerald-400" id="statGiven">‚Äî</div>
                        <div class="text-xs text-gray-500 mt-0.5">Received Tute</div>
                    </div>
                    <div class="bg-gray-900 border border-red-500/20 rounded-2xl p-4 text-center">
                        <div class="text-2xl font-bold text-red-400" id="statMissing">‚Äî</div>
                        <div class="text-xs text-gray-500 mt-0.5">Not Yet Given</div>
                    </div>
                </div>

                <!-- Student list -->
                <div id="studentListWrap" class="bg-gray-900 border border-gray-800 rounded-2xl overflow-hidden">
                    <div id="emptyState" class="flex flex-col items-center justify-center py-20 text-gray-600">
                        <div class="text-5xl mb-4 opacity-30">üì¶</div>
                        <div class="font-medium text-gray-500">Select a tute above to manage distribution</div>
                        <div class="text-sm mt-1">Or create a new tute with the button above</div>
                    </div>
                    <table class="w-full text-sm hidden" id="studentTable">
                        <thead>
                            <tr class="border-b border-gray-800 bg-gray-800/50">
                                <th
                                    class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                    Student</th>
                                <th
                                    class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider hidden sm:table-cell">
                                    Grade</th>
                                <th
                                    class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                    Subject(s)</th>
                                <th
                                    class="text-center px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                    Received?</th>
                                <th
                                    class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider hidden md:table-cell">
                                    Date Given</th>
                                <th
                                    class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider hidden lg:table-cell">
                                    Note</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Tute Modal -->
    <div id="modal"
        class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div
            class="modal-enter bg-gray-900 border border-gray-700 rounded-t-3xl sm:rounded-2xl w-full sm:max-w-md shadow-2xl">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800">
                <h2 class="font-bold text-white text-base" id="modalTitle">Create New Tute</h2>
                <button onclick="closeModal()"
                    class="w-8 h-8 flex items-center justify-center rounded-xl bg-gray-800 hover:bg-gray-700 text-gray-400 text-lg">‚úï</button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="editId">
                <div>
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5 block">Tute /
                        Handout Name *</label>
                    <input id="tuteName"
                        class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-indigo-500 transition-colors"
                        placeholder="e.g. Chapter 5 Notes ‚Äì Science">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label
                            class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5 block">Subject</label>
                        <select id="tuteSubject"
                            class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500 transition-colors">
                            <option value="">All / General</option>
                            <option>Science</option>
                            <option>Maths</option>
                            <option>Tamil</option>
                            <option>English</option>
                        </select>
                    </div>
                    <div>
                        <label
                            class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5 block">Grade</label>
                        <select id="tuteGrade"
                            class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500 transition-colors">
                            <option value="">All Grades</option>
                            <option>6</option>
                            <option>7</option>
                            <option>8</option>
                            <option>9</option>
                            <option>10</option>
                            <option>11</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5 block">Date
                        Distributed</label>
                    <input id="tuteDate" type="date"
                        class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500 transition-colors">
                </div>
                <div>
                    <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1.5 block">Description
                        (optional)</label>
                    <textarea id="tuteDesc" rows="2"
                        class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-indigo-500 transition-colors resize-none"
                        placeholder="Brief notes about this tute‚Ä¶"></textarea>
                </div>
            </div>
            <div class="flex gap-3 px-6 py-4 border-t border-gray-800">
                <button onclick="closeModal()"
                    class="flex-1 py-2.5 rounded-xl bg-gray-800 hover:bg-gray-700 text-gray-300 text-sm font-medium transition-colors">Cancel</button>
                <button onclick="saveTute()" id="saveBtn"
                    class="flex-1 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold transition-colors"><span
                        id="saveTxt">Create Tute</span></button>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div id="noteModal"
        class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div
            class="modal-enter bg-gray-900 border border-gray-700 rounded-t-3xl sm:rounded-2xl w-full sm:max-w-sm shadow-2xl">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800">
                <h2 class="font-bold text-white text-base">Add Note</h2>
                <button onclick="closeNoteModal()"
                    class="w-8 h-8 flex items-center justify-center rounded-xl bg-gray-800 hover:bg-gray-700 text-gray-400 text-lg">‚úï</button>
            </div>
            <div class="p-6 space-y-3">
                <div class="text-sm text-gray-300 font-medium" id="noteStudentName"></div>
                <input type="hidden" id="noteStudentId">
                <textarea id="noteText" rows="3" placeholder="e.g. Said didn't attend that day"
                    class="w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2.5 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-indigo-500 resize-none"></textarea>
            </div>
            <div class="flex gap-3 px-6 py-4 border-t border-gray-800">
                <button onclick="closeNoteModal()"
                    class="flex-1 py-2.5 rounded-xl bg-gray-800 text-gray-300 text-sm font-medium">Cancel</button>
                <button onclick="saveNote()"
                    class="flex-1 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold">Save
                    Note</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { collection, addDoc, updateDoc, deleteDoc, getDocs, doc, setDoc, getDoc, serverTimestamp, query, orderBy, where }
            from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { db } from "../js/firebase-config.js";
        import { showToast, confirmAction } from "../js/app.js";

        // Sidebar user
        try { const s = JSON.parse(localStorage.getItem('phoenixSession') || 'null'); if (s) document.getElementById('sidebarUser').textContent = s.displayName || s.username; } catch { }

        let allTutes = [], allStudents = [], currentTuteId = null, records = {};
        // records key = studentId ‚Üí { given, date, note }

        // ‚îÄ‚îÄ Load tute dropdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadTutes() {
            const snap = await getDocs(query(collection(db, 'tutes'), orderBy('createdAt', 'desc')));
            allTutes = []; snap.forEach(d => allTutes.push({ id: d.id, ...d.data() }));
            const sel = document.getElementById('tuteSelect');
            while (sel.options.length > 1) sel.remove(1);
            allTutes.forEach(t => {
                const label = `${t.name}${t.subject ? ' ¬∑ ' + t.subject : ''}${t.grade ? ' ¬∑ Gr ' + t.grade : ''}${t.date ? ' (' + t.date + ')' : ''}`;
                sel.appendChild(new Option(label, t.id));
            });
        }

        // ‚îÄ‚îÄ Load students ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadStudents() {
            const snap = await getDocs(collection(db, 'students'));
            allStudents = []; snap.forEach(d => allStudents.push({ id: d.id, ...d.data() }));
            allStudents.sort((a, b) => (a.firstName || '').localeCompare(b.firstName || ''));
        }

        // ‚îÄ‚îÄ Load records for a specific tute ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadRecords(tuteId) {
            const snap = await getDocs(collection(db, 'tutes', tuteId, 'records'));
            records = {};
            snap.forEach(d => { records[d.id] = d.data(); });
        }

        // ‚îÄ‚îÄ On tute select change ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.loadTuteStudents = async function () {
            const tuteId = document.getElementById('tuteSelect').value;
            if (!tuteId) {
                currentTuteId = null;
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('studentTable').classList.add('hidden');
                document.getElementById('statsBar').classList.add('hidden');
                return;
            }
            currentTuteId = tuteId;
            document.getElementById('emptyState').innerHTML = `<div class="flex items-center gap-2 py-20 text-gray-600"><svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.37 0 0 5.37 0 12h4z"/></svg>Loading‚Ä¶</div>`;
            document.getElementById('emptyState').classList.remove('hidden');
            await loadRecords(tuteId);
            document.getElementById('statsBar').classList.remove('hidden');
            document.getElementById('statsBar').classList.add('grid');
            applyFilter();
        };

        // ‚îÄ‚îÄ Filter + render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.applyFilter = function () {
            if (!currentTuteId) return;
            const q = document.getElementById('q').value.toLowerCase();
            const fg = document.getElementById('fGrade').value;
            const fs = document.getElementById('fSub').value;
            const fst = document.getElementById('fStatus').value;

            // Get the current tute's own subject & grade as the base filter
            const tute = allTutes.find(t => t.id === currentTuteId);
            const tuteSubject = tute?.subject || '';   // e.g. "Science" or "" for all
            const tuteGrade = tute?.grade || '';   // e.g. "8" or "" for all

            let list = allStudents.filter(s => {
                const subs = s.subjects || [s.subject || ''].filter(Boolean);

                // ‚îÄ‚îÄ Tute-level hard filter (subject & grade from the tute itself) ‚îÄ‚îÄ
                const tuteSub = !tuteSubject || subs.includes(tuteSubject);
                const tuteGradeMatch = !tuteGrade || String(s.grade) === tuteGrade;

                // ‚îÄ‚îÄ Additional manual filter dropdowns ‚îÄ‚îÄ
                const gradeMatch = !fg || String(s.grade) === fg;
                const subMatch = !fs || subs.includes(fs);
                const nameMatch = !q || `${s.firstName} ${s.lastName}`.toLowerCase().includes(q);
                const rec = records[s.id];
                const given = !!rec?.given;
                const statusMatch = !fst || (fst === 'given' ? given : !given);

                return tuteSub && tuteGradeMatch && gradeMatch && subMatch && nameMatch && statusMatch;
            });

            updateStats(list);
            renderTable(list);
        };

        function updateStats(list) {
            const total = list.length;
            const given = list.filter(s => records[s.id]?.given).length;
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statGiven').textContent = given;
            document.getElementById('statMissing').textContent = total - given;
        }

        // Subject badge styles
        const SUB_STYLE = {
            Science: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20',
            Maths: 'bg-amber-500/10  text-amber-400  border-amber-500/20',
            Tamil: 'bg-sky-500/10    text-sky-400    border-sky-500/20',
            English: 'bg-violet-500/10 text-violet-400 border-violet-500/20'
        };

        function renderTable(list) {
            document.getElementById('emptyState').classList.add('hidden');
            const table = document.getElementById('studentTable');
            const tb = document.getElementById('tbody');
            if (!list.length) {
                table.classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('emptyState').innerHTML = `<div class="flex flex-col items-center py-16 text-gray-600"><div class="text-4xl mb-3 opacity-30">üîç</div><div class="font-medium text-gray-500">No students match the current filters</div></div>`;
                return;
            }
            table.classList.remove('hidden');

            tb.innerHTML = list.map((s, i) => {
                const rec = records[s.id] || {};
                const given = !!rec.given;
                const subs = s.subjects || [s.subject || ''].filter(Boolean);
                const subBadges = subs.map(sub => `<span class="inline-flex px-2 py-0.5 rounded-lg ${SUB_STYLE[sub] || 'bg-gray-700 text-gray-400 border-gray-600'} text-[11px] font-semibold border">${sub}</span>`).join(' ');
                const checkedAttr = given ? 'checked' : '';
                const rowBg = given ? 'bg-emerald-500/5' : '';
                const ini = ((s.firstName || '?')[0] + (s.lastName || '?')[0]).toUpperCase();
                const dateGiven = rec.date || '';
                const noteText = rec.note || '';

                return `<tr class="student-row border-b border-gray-800 transition-colors ${rowBg} card-anim" style="animation-delay:${i * .025}s" id="row_${s.id}">
              <td class="px-4 py-3">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-full bg-gradient-to-br ${given ? 'from-emerald-500 to-teal-600' : 'from-gray-600 to-gray-700'} flex items-center justify-center text-xs font-bold text-white shrink-0">${ini}</div>
                  <div>
                    <div class="font-medium text-white text-sm">${s.firstName} ${s.lastName}</div>
                    <div class="text-xs text-gray-500">${s.parentContact || ''}</div>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3 hidden sm:table-cell"><span class="inline-flex px-2 py-0.5 rounded-lg bg-indigo-500/10 text-indigo-400 text-[11px] font-medium border border-indigo-500/20">Grade ${s.grade || '?'}</span></td>
              <td class="px-4 py-3">${subBadges || '‚Äî'}</td>
              <td class="px-4 py-3 text-center">
                <label class="inline-flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" class="check-given" ${checkedAttr} onchange="toggleGiven('${s.id}', this)">
                  <span class="text-sm ${given ? 'text-emerald-400 font-semibold' : 'text-gray-500'}">${given ? '‚úÖ Given' : 'Not given'}</span>
                </label>
              </td>
              <td class="px-4 py-3 text-gray-400 text-xs hidden md:table-cell">${dateGiven || '‚Äî'}</td>
              <td class="px-4 py-3 hidden lg:table-cell">
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-500 truncate max-w-[120px]" id="noteDisplay_${s.id}">${noteText || '‚Äî'}</span>
                  <button onclick="openNoteModal('${s.id}','${(s.firstName + ' ' + s.lastName).replace(/'/g, "\\'")}','${noteText.replace(/'/g, "\\'")}')" class="w-6 h-6 flex items-center justify-center rounded-lg bg-gray-800 hover:bg-indigo-500/20 hover:text-indigo-400 text-gray-500 text-xs shrink-0">‚úèÔ∏è</button>
                </div>
              </td>
            </tr>`;
            }).join('');
        }

        // ‚îÄ‚îÄ Toggle given status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.toggleGiven = async function (studentId, checkbox) {
            if (!currentTuteId) return;
            const given = checkbox.checked;
            const today = new Date().toISOString().slice(0, 10);
            try {
                const recRef = doc(db, 'tutes', currentTuteId, 'records', studentId);
                if (given) {
                    await setDoc(recRef, { given: true, date: today, note: records[studentId]?.note || '', updatedAt: serverTimestamp() }, { merge: true });
                    records[studentId] = { ...records[studentId], given: true, date: today };
                } else {
                    await setDoc(recRef, { given: false, note: records[studentId]?.note || '', updatedAt: serverTimestamp() }, { merge: true });
                    records[studentId] = { ...records[studentId], given: false, date: '' };
                }
                // Update row visuals without full re-render
                const row = document.getElementById(`row_${studentId}`);
                if (row) {
                    row.classList.toggle('bg-emerald-500/5', given);
                    const label = checkbox.nextElementSibling;
                    if (label) { label.textContent = given ? '‚úÖ Given' : 'Not given'; label.className = `text-sm ${given ? 'text-emerald-400 font-semibold' : 'text-gray-500'}`; }
                    const avatar = row.querySelector('.rounded-full');
                    if (avatar) avatar.className = `w-8 h-8 rounded-full bg-gradient-to-br ${given ? 'from-emerald-500 to-teal-600' : 'from-gray-600 to-gray-700'} flex items-center justify-center text-xs font-bold text-white shrink-0`;
                }
                // Update stats ‚Äî respect tute's own subject/grade boundary
                const fg = document.getElementById('fGrade').value;
                const fs = document.getElementById('fSub').value;
                const tute = allTutes.find(t => t.id === currentTuteId);
                const tuteSubject = tute?.subject || '';
                const tuteGrade = tute?.grade || '';
                const filteredList = allStudents.filter(s => {
                    const subs = s.subjects || [s.subject || ''].filter(Boolean);
                    return (!tuteSubject || subs.includes(tuteSubject))
                        && (!tuteGrade || String(s.grade) === tuteGrade)
                        && (!fg || String(s.grade) === fg)
                        && (!fs || subs.includes(fs));
                });
                updateStats(filteredList);
            } catch (e) { showToast('Failed to save: ' + e.message, 'error'); checkbox.checked = !given; }
        };

        // ‚îÄ‚îÄ Note modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.openNoteModal = function (sid, name, existingNote) {
            document.getElementById('noteStudentId').value = sid;
            document.getElementById('noteStudentName').textContent = '‚úèÔ∏è Note for ' + name;
            document.getElementById('noteText').value = existingNote === 'undefined' ? '' : (existingNote || '');
            document.getElementById('noteModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };
        window.closeNoteModal = function () { document.getElementById('noteModal').classList.add('hidden'); document.body.style.overflow = ''; };
        window.saveNote = async function () {
            if (!currentTuteId) return;
            const sid = document.getElementById('noteStudentId').value;
            const note = document.getElementById('noteText').value.trim();
            try {
                const recRef = doc(db, 'tutes', currentTuteId, 'records', sid);
                await setDoc(recRef, { note, updatedAt: serverTimestamp() }, { merge: true });
                if (!records[sid]) records[sid] = {};
                records[sid].note = note;
                const el = document.getElementById(`noteDisplay_${sid}`);
                if (el) el.textContent = note || '‚Äî';
                showToast('Note saved', 'success');
                closeNoteModal();
            } catch (e) { showToast('Failed: ' + e.message, 'error'); }
        };

        // ‚îÄ‚îÄ Create/Edit Tute modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.openCreateTute = function () {
            document.getElementById('editId').value = '';
            document.getElementById('tuteName').value = '';
            document.getElementById('tuteSubject').value = '';
            document.getElementById('tuteGrade').value = '';
            document.getElementById('tuteDate').value = new Date().toISOString().slice(0, 10);
            document.getElementById('tuteDesc').value = '';
            document.getElementById('modalTitle').textContent = 'Create New Tute';
            document.getElementById('saveTxt').textContent = 'Create Tute';
            document.getElementById('modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        };
        window.closeModal = function () { document.getElementById('modal').classList.add('hidden'); document.body.style.overflow = ''; };

        window.saveTute = async function () {
            const name = document.getElementById('tuteName').value.trim();
            if (!name) { showToast('Tute name is required', 'error'); return; }
            const btn = document.getElementById('saveBtn'); btn.disabled = true;
            const data = {
                name,
                subject: document.getElementById('tuteSubject').value,
                grade: document.getElementById('tuteGrade').value,
                date: document.getElementById('tuteDate').value,
                description: document.getElementById('tuteDesc').value.trim(),
                createdAt: serverTimestamp()
            };
            try {
                const ref = await addDoc(collection(db, 'tutes'), data);
                showToast('Tute created!', 'success');
                closeModal();
                await loadTutes();
                // Auto-select new tute
                document.getElementById('tuteSelect').value = ref.id;
                await window.loadTuteStudents();
            } catch (e) { showToast('Failed: ' + e.message, 'error'); }
            finally { btn.disabled = false; }
        };

        // ‚îÄ‚îÄ Delete tute ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        window.deleteTute = async function (id) {
            if (!await confirmAction('Delete this tute and all its distribution records? This cannot be undone.')) return;
            try {
                // Delete all subcollection records first
                const rSnap = await getDocs(collection(db, 'tutes', id, 'records'));
                await Promise.all(rSnap.docs.map(d => deleteDoc(d.ref)));
                await deleteDoc(doc(db, 'tutes', id));
                showToast('Tute deleted', 'info');
                currentTuteId = null;
                records = {};
                await loadTutes();
                document.getElementById('tuteSelect').value = '';
                window.loadTuteStudents();
            } catch (e) { showToast('Delete failed', 'error'); }
        };

        // Init
        await loadStudents();
        await loadTutes();
    </script>
</body>

</html>