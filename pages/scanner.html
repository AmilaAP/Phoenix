<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner â€“ Phonex Institute</title>
    <meta name="description" content="Scan student QR codes to record attendance at Phonex Institute.">
    <link rel="stylesheet" href="../css/style.css">
    <!-- html5-qrcode library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>

<body>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-layout">

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="logo-icon">ğŸ“</div>
                <div class="logo-text">
                    <h2>Phonex</h2>
                    <p>Institute System</p>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section-title">Main</div>
                <a href="../index.html" class="nav-link">
                    <div class="nav-icon">ğŸ“Š</div> Dashboard
                </a>
                <a href="students.html" class="nav-link">
                    <div class="nav-icon">ğŸ‘¨â€ğŸ“</div> Students
                </a>
                <a href="attendance.html" class="nav-link">
                    <div class="nav-icon">ğŸ“‹</div> Attendance
                </a>
                <a href="payments.html" class="nav-link">
                    <div class="nav-icon">ğŸ’³</div> Payments
                </a>
                <div class="nav-section-title" style="margin-top:8px">Scanner</div>
                <a href="scanner.html" class="nav-link active">
                    <div class="nav-icon">ğŸ“·</div> QR Scanner
                </a>
                <a href="qr-codes.html" class="nav-link">
                    <div class="nav-icon">ğŸ”²</div> QR Codes
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="user-avatar">A</div>
                    <div>
                        <div style="font-size:13px;font-weight:600">Admin</div>
                        <div style="font-size:11px;color:var(--text-muted)">Institute Manager</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <div class="main-content">
            <div class="topbar">
                <div style="display:flex;align-items:center;gap:12px">
                    <button class="mobile-menu-btn" id="mobileMenuBtn">â˜°</button>
                    <div class="topbar-left">
                        <h1>QR Scanner</h1>
                        <p id="scanDate">Loading dateâ€¦</p>
                    </div>
                </div>
                <div class="topbar-right">
                    <span class="badge badge-info" id="scanCount">0 Scanned Today</span>
                </div>
            </div>

            <div class="page-content">

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start">

                    <!-- Scanner Panel -->
                    <div>
                        <div class="card" style="margin-bottom:16px">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">ğŸ“· Camera Scanner</div>
                                    <div class="card-subtitle">Point camera at student's QR code</div>
                                </div>
                                <div style="display:flex;gap:8px">
                                    <button class="btn btn-primary btn-sm" id="startBtn" onclick="startScanner()">Start
                                        Camera</button>
                                    <button class="btn btn-ghost btn-sm" id="stopBtn" onclick="stopScanner()"
                                        style="display:none">Stop</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- QR Reader container -->
                                <div id="reader" style="width:100%;min-height:260px"></div>
                                <p style="font-size:11px;color:var(--text-muted);margin-top:12px;text-align:center">
                                    ğŸ“± This page works best on mobile â€” open it in your phone's browser
                                </p>
                            </div>
                        </div>

                        <!-- Scan Result -->
                        <div id="scanResultContainer" style="display:none"></div>

                        <!-- Manual Entry fallback -->
                        <div class="card" style="margin-top:16px">
                            <div class="card-header">
                                <div class="card-title">âŒ¨ï¸ Manual Student ID Entry</div>
                            </div>
                            <div class="card-body" style="display:flex;gap:10px">
                                <input type="text" class="form-control" id="manualId"
                                    placeholder="Paste or type Student IDâ€¦" style="flex:1">
                                <button class="btn btn-success" onclick="manualMark()">Mark Present</button>
                            </div>
                        </div>
                    </div>

                    <!-- Today's Attendance Log -->
                    <div class="card" style="height:fit-content">
                        <div class="card-header">
                            <div>
                                <div class="card-title">ğŸ“‹ Today's Log</div>
                                <div class="card-subtitle" id="logSubtitle">0 students present</div>
                            </div>
                            <button class="btn btn-ghost btn-sm" onclick="refreshLog()">â†» Refresh</button>
                        </div>
                        <div class="card-body" id="todayLog" style="max-height:500px;overflow-y:auto">
                            <div class="page-loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import {
            getFirestore, collection, addDoc, getDocs,
            query, where, serverTimestamp, doc, getDoc
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { firebaseConfig } from "../js/firebase-config.js";
        import { showToast, initials, formatTime } from "../js/app.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // â”€â”€ Today â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const today = new Date();
        const todayKey = today.toISOString().slice(0, 10);
        document.getElementById('scanDate').textContent =
            today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        // â”€â”€ Scanner state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let html5QrcodeScanner = null;
        let scanning = false;
        let processingQr = false; // debounce multiple scans

        // â”€â”€ Start scanner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.startScanner = function () {
            if (scanning) return;
            scanning = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = '';

            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                (err) => { /* ignore frequent decode errors */ }
            ).catch(err => {
                showToast('Cannot access camera: ' + err, 'error');
                scanning = false;
                document.getElementById('startBtn').style.display = '';
                document.getElementById('stopBtn').style.display = 'none';
            });
        };

        // â”€â”€ Stop scanner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.stopScanner = function () {
            if (!scanning) return;
            html5QrcodeScanner?.stop().then(() => {
                html5QrcodeScanner.clear();
                scanning = false;
                document.getElementById('startBtn').style.display = '';
                document.getElementById('stopBtn').style.display = 'none';
            }).catch(console.error);
        };

        // â”€â”€ On scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function onScanSuccess(decodedText) {
            if (processingQr) return;
            processingQr = true;

            // Brief vibration on mobile
            navigator?.vibrate?.(200);

            await markAttendance(decodedText.trim());

            // Debounce: allow next scan after 3 seconds
            setTimeout(() => { processingQr = false; }, 3000);
        }

        // â”€â”€ Core attendance marking function â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function markAttendance(studentId) {
            const container = document.getElementById('scanResultContainer');
            container.style.display = 'block';
            container.innerHTML = `<div class="scan-result-card">
    <div class="loading-spinner"></div>
    <span>Processingâ€¦</span>
  </div>`;

            try {
                // Get student
                const studentDoc = await getDoc(doc(db, 'students', studentId));
                if (!studentDoc.exists()) {
                    container.innerHTML = `<div class="scan-result-card error">
        <span style="font-size:24px">âŒ</span>
        <div>
          <div style="font-weight:600;color:var(--danger)">Unknown Student</div>
          <div style="font-size:12px;color:var(--text-muted)">ID: ${studentId.slice(0, 12)}â€¦</div>
        </div>
      </div>`;
                    showToast('Student not found in database.', 'error');
                    return;
                }

                const student = { id: studentDoc.id, ...studentDoc.data() };

                // Check if already scanned today (only first record counts)
                const existingSnap = await getDocs(query(
                    collection(db, 'attendance'),
                    where('studentId', '==', studentId),
                    where('date', '==', todayKey)
                ));

                if (!existingSnap.empty) {
                    // Already marked â€” show duplicate warning
                    const firstRecord = existingSnap.docs[0].data();
                    const scanTime = formatTime(firstRecord.scannedAt?.toDate?.() || firstRecord.scannedAt);
                    container.innerHTML = `<div class="scan-result-card duplicate">
        <span style="font-size:36px">âš ï¸</span>
        <div>
          <div style="font-weight:700;font-size:15px;color:var(--warning)">Already Marked Present</div>
          <div style="font-size:13px;color:var(--text-primary);margin-top:2px">
            ${student.firstName} ${student.lastName}
          </div>
          <div style="font-size:12px;color:var(--text-muted);margin-top:4px">
            First scan was recorded at ${scanTime}
          </div>
        </div>
      </div>`;
                    showToast(`${student.firstName} already marked â€” first scan at ${scanTime}`, 'warning');
                    await refreshLog();
                    return;
                }

                // Record new attendance
                await addDoc(collection(db, 'attendance'), {
                    studentId,
                    studentName: `${student.firstName} ${student.lastName}`,
                    date: todayKey,
                    scannedAt: serverTimestamp(),
                    subject: student.subject || '',
                    grade: student.grade || ''
                });

                const ini = initials(student.firstName, student.lastName);
                container.innerHTML = `<div class="scan-result-card">
      <div class="student-avatar" style="width:48px;height:48px;font-size:18px">${ini}</div>
      <div>
        <div style="font-weight:700;font-size:16px;color:var(--success)">âœ… Attendance Recorded!</div>
        <div style="font-size:14px;color:var(--text-primary);margin-top:2px">
          ${student.firstName} ${student.lastName}
        </div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:4px">
          Grade ${student.grade} â€¢ ${student.subject}
        </div>
      </div>
    </div>`;

                showToast(`âœ… ${student.firstName} ${student.lastName} â€“ Attendance recorded!`, 'success');
                await refreshLog();

            } catch (err) {
                console.error(err);
                container.innerHTML = `<div class="scan-result-card error">
      <span style="font-size:24px">âŒ</span>
      <div>
        <div style="font-weight:600;color:var(--danger)">Error</div>
        <div style="font-size:12px;color:var(--text-muted)">${err.message}</div>
      </div>
    </div>`;
                showToast('Error recording attendance.', 'error');
            }
        }

        // â”€â”€ Manual entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.manualMark = async function () {
            const id = document.getElementById('manualId').value.trim();
            if (!id) { showToast('Please enter a student ID.', 'warning'); return; }
            document.getElementById('manualId').value = '';
            await markAttendance(id);
        };

        // â”€â”€ Refresh today's log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.refreshLog = async function () {
            const logEl = document.getElementById('todayLog');
            try {
                const snap = await getDocs(query(
                    collection(db, 'attendance'),
                    where('date', '==', todayKey)
                ));

                const records = [];
                snap.forEach(d => records.push({ id: d.id, ...d.data() }));
                records.sort((a, b) => (b.scannedAt?.seconds || 0) - (a.scannedAt?.seconds || 0));

                document.getElementById('scanCount').textContent = `${records.length} Scanned Today`;
                document.getElementById('logSubtitle').textContent = `${records.length} student${records.length !== 1 ? 's' : ''} present`;

                if (records.length === 0) {
                    logEl.innerHTML = `<div class="empty-state">
        <div class="empty-icon">ğŸ“·</div>
        <h3>No Scans Yet</h3>
        <p>Start the camera and scan student QR codes.</p>
      </div>`;
                    return;
                }

                logEl.innerHTML = records.map((r, i) => {
                    const ini = (r.studentName || '?').split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
                    const time = formatTime(r.scannedAt?.toDate?.() || r.scannedAt);
                    return `<div class="attendance-item">
        <div style="font-size:12px;color:var(--text-muted);width:24px;text-align:center">${i + 1}</div>
        <div class="student-avatar">${ini}</div>
        <div style="flex:1">
          <div class="student-name">${r.studentName || 'Unknown'}</div>
          <div class="student-id">Grade ${r.grade} â€¢ ${r.subject}</div>
        </div>
        <div class="attendance-time">${time}</div>
      </div>`;
                }).join('');

            } catch (err) {
                logEl.innerHTML = `<div class="empty-state"><div class="empty-icon">âš ï¸</div>
      <h3>Cannot load log</h3><p>Check Firebase config.</p></div>`;
            }
        };

        // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const mobileBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        mobileBtn?.addEventListener('click', () => { sidebar.classList.toggle('open'); overlay.classList.toggle('open'); });
        overlay?.addEventListener('click', () => { sidebar.classList.remove('open'); overlay.classList.remove('open'); });

        refreshLog();
    </script>
</body>

</html>